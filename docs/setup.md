# Setup Guide

This guide will walk you through setting up the MCP OAuth Sample project from scratch. Follow these steps carefully to ensure a smooth installation and configuration process.

## Prerequisites

Before you begin, ensure you have the following installed on your system:

### Required Software

- **Node.js v18 or higher** - The project uses Next.js 15 which requires Node.js 18+
- **PostgreSQL 12 or higher** - Database for storing OAuth clients, tokens, and analytics data
- **pnpm** - Package manager (recommended) or npm/yarn
- **Git** - Version control

### System Requirements

- **Operating System**: macOS, Linux, or Windows
- **RAM**: Minimum 4GB (8GB recommended)
- **Storage**: At least 1GB free space for dependencies and database

## Step 1: Install Prerequisites

### Node.js Installation

**macOS (using Homebrew):**
```bash
brew install node@18
```

**Ubuntu/Debian:**
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**Windows:**
Download and install from [nodejs.org](https://nodejs.org/)

**Verify Installation:**
```bash
node --version  # Should be v18.0.0 or higher
npm --version
```

### PostgreSQL Installation

**macOS (using Homebrew):**
```bash
# Install PostgreSQL
brew install postgresql@14

# Start PostgreSQL service
brew services start postgresql@14

# Create a database user (optional)
createuser --interactive
```

**Ubuntu/Debian:**
```bash
# Install PostgreSQL
sudo apt update
sudo apt install postgresql postgresql-contrib

# Start PostgreSQL service
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Create a database and user
sudo -u postgres psql
CREATE DATABASE mcp_oauth_sample;
CREATE USER mcp_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE mcp_oauth_sample TO mcp_user;
\q
```

**Windows:**
1. Download PostgreSQL from [postgresql.org](https://www.postgresql.org/download/windows/)
2. Run the installer and follow the setup wizard
3. Remember the superuser password you set during installation

### pnpm Installation

```bash
# Install pnpm globally
npm install -g pnpm

# Verify installation
pnpm --version
```

## Step 2: Clone and Install Dependencies

```bash
# Clone the repository
git clone https://github.com/raxITai/mcp-oauth-sample.git
cd mcp-oauth-sample

# Install dependencies
pnpm install
```

## Step 3: Environment Variables Setup

Create environment files for your configuration:

```bash
# Copy environment template
cp .env.example .env
```

If `.env.example` doesn't exist, create a new `.env` file with the following variables:

### Required Environment Variables

Edit your `.env` file and add the following variables:

```bash
# Created by Vercel CLI
AUTH_SECRET="your-32-character-random-string"
DATABASE_URL="postgres://username:password@host:5432/database?sslmode=require"
GOOGLE_CLIENT_ID="your-google-client-id.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="your-google-client-secret"
POSTGRES_URL="postgres://username:password@host:5432/database?sslmode=require"
PRISMA_DATABASE_URL="prisma+postgres://accelerate.prisma-data.net/?api_key=your-api-key"
REDIS_URL="rediss://user:pass@host:6379"
VERCEL_OIDC_TOKEN="your-vercel-oidc-token"
ADMIN_EMAIL="admin@example.com"
```

### Environment Variable Explanations

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `AUTH_SECRET` | Secret key for NextAuth.js session encryption | ✅ | Generate with `openssl rand -base64 32` |
| `DATABASE_URL` | PostgreSQL connection string | ✅ | `postgres://user:pass@db.prisma.io:5432/?sslmode=require` |
| `GOOGLE_CLIENT_ID` | Google OAuth 2.0 client ID | ✅ | `123456789-abc.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuth 2.0 client secret | ✅ | `GOCSPX-abcdefghijklmnop` |
| `POSTGRES_URL` | Alternative PostgreSQL URL format | ✅ | Same as `DATABASE_URL` |
| `PRISMA_DATABASE_URL` | Prisma Accelerate connection string | ✅ | `prisma+postgres://accelerate.prisma-data.net/?api_key=...` |
| `ADMIN_EMAIL` | Gmail address(es) for analytics dashboard access | ✅ | `admin@gmail.com` or `admin1@gmail.com,admin2@gmail.com` |
| `REDIS_URL` | Redis connection URL for SSE transport | ⚠️ | `rediss://user:pass@host:6379` |
| `VERCEL_OIDC_TOKEN` | Vercel OIDC token for deployment | 🔄 | Auto-generated by Vercel CLI |

### Important Environment Variable Notes

#### ADMIN_EMAIL (Required for Analytics Dashboard)
The `ADMIN_EMAIL` variable controls access to the analytics dashboard at `/analytics`. Only users who sign in with Gmail addresses listed in this variable will be able to access the dashboard.

**Single admin email:**
```bash
ADMIN_EMAIL="admin@gmail.com"
```

**Multiple admin emails (comma-separated):**
```bash
ADMIN_EMAIL="admin1@gmail.com,admin2@gmail.com,admin3@gmail.com"
```

**Important notes:**
- Only Gmail addresses are supported (Google OAuth authentication)
- Emails are case-insensitive when checked
- Spaces around commas are automatically trimmed
- Empty emails in the list are ignored
- All listed Gmail addresses will have full admin access to analytics

#### PRISMA_DATABASE_URL (Prisma Accelerate)
If you're using Prisma Accelerate for enhanced database performance, you'll need this connection string. For local development, you can use just `DATABASE_URL`.

### Generating AUTH_SECRET

Generate a secure random string for `AUTH_SECRET`:

```bash
# Using OpenSSL (macOS/Linux)
openssl rand -base64 32

# Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

## Step 4: Google OAuth Configuration

To enable Google authentication, you need to set up a Google Cloud Console project:

### Create Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Enable the Google+ API and Google OAuth2 API

### Configure OAuth Consent Screen

1. Navigate to **APIs & Services** > **OAuth consent screen**
2. Choose **External** user type (unless you have a Google Workspace)
3. Fill in the required fields:
   - **App name**: Your application name
   - **User support email**: Your email
   - **Developer contact information**: Your email
4. Add scopes (default scopes are sufficient for basic auth)
5. Add test users if in development mode

### Create OAuth 2.0 Credentials

1. Navigate to **APIs & Services** > **Credentials**
2. Click **Create Credentials** > **OAuth 2.0 Client IDs**
3. Choose **Web application**
4. Configure:
   - **Name**: Your app name
   - **Authorized JavaScript origins**: 
     - `http://localhost:3000` (development)
     - `https://yourdomain.com` (production)
   - **Authorized redirect URIs**:
     - `http://localhost:3000/api/auth/callback/google` (development)
     - `https://yourdomain.com/api/auth/callback/google` (production)
5. Copy the **Client ID** and **Client Secret** to your `.env` file

## Step 5: Database Setup

### Initialize Database Schema

```bash
# Generate Prisma client
pnpm prisma generate

# Push schema to database (for development)
pnpm prisma db push

# Or create and run migrations (for production)
pnpm prisma migrate dev --name init
```

### Verify Database Connection

```bash
# Open Prisma Studio to inspect your database
pnpm prisma studio
```

This will open a web interface at `http://localhost:5555` where you can view and edit your database records.

### Database Connection Troubleshooting

If you encounter database connection issues:

1. **Check PostgreSQL is running:**
   ```bash
   # macOS
   brew services list | grep postgresql
   
   # Linux
   sudo systemctl status postgresql
   ```

2. **Test connection manually:**
   ```bash
   psql "postgresql://username:password@localhost:5432/mcp_oauth_sample"
   ```

3. **Check database exists:**
   ```sql
   \l  -- List all databases
   \q  -- Quit
   ```

## Step 6: First Run

### Start Development Server

```bash
# Start the development server
pnpm dev
```

The application will be available at `http://localhost:3000`.

### Build for Production

```bash
# Build the application
pnpm build

# Start production server
pnpm start
```

## Step 7: Verification Steps

### 1. Basic Application Access

1. Open `http://localhost:3000` in your browser
2. You should see the application homepage
3. Check that the site loads without errors in the browser console

### 2. Authentication Flow

1. Click on any "Sign In" button or navigate to a protected route
2. You should be redirected to Google OAuth
3. Sign in with your Google account
4. Verify you're redirected back to the application
5. Check that your user appears in the database via Prisma Studio

### 3. MCP Endpoints

Test the MCP endpoints are accessible:

```bash
# Test MCP SSE endpoint
curl -I http://localhost:3000/mcp/sse

# Test MCP HTTP endpoint  
curl -I http://localhost:3000/mcp/mcp

# Test OAuth discovery endpoint
curl http://localhost:3000/.well-known/oauth-authorization-server
```

### 4. Analytics Dashboard

1. Sign in to the application
2. Navigate to `/analytics`
3. Verify the analytics dashboard loads
4. Check that basic metrics are displayed

### 5. Database Verification

Using Prisma Studio (`pnpm prisma studio`):

1. Check that User records are created when you sign in
2. Verify Account records link to your Google OAuth account
3. Confirm Session records are created for active sessions

## Troubleshooting

### Common Issues and Solutions

#### 1. "Module not found" errors

**Solution:**
```bash
# Clear node_modules and reinstall
rm -rf node_modules pnpm-lock.yaml
pnpm install
```

#### 2. Prisma client generation issues

**Solution:**
```bash
# Regenerate Prisma client
pnpm prisma generate --no-engine
```

#### 3. Database connection refused

**Solution:**
- Ensure PostgreSQL is running: `brew services start postgresql@14`
- Check DATABASE_URL format: `postgresql://user:password@host:port/database`
- Verify database exists and user has permissions

#### 4. Google OAuth errors

**Solution:**
- Verify GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET are correct
- Check redirect URIs match exactly in Google Cloud Console
- Ensure OAuth consent screen is configured properly

#### 5. Next.js build errors

**Solution:**
```bash
# Clear Next.js cache
rm -rf .next
pnpm build
```

#### 6. Port already in use

**Solution:**
```bash
# Kill process using port 3000
lsof -ti:3000 | xargs kill -9

# Or use a different port
pnpm dev -- -p 3001
```

### Environment-Specific Issues

#### macOS Issues

- **Homebrew permissions**: If you get permission errors, run `sudo chown -R $(whoami) /opt/homebrew`
- **Node.js path issues**: Add `/opt/homebrew/bin` to your PATH

#### Linux Issues

- **PostgreSQL peer authentication**: Edit `/etc/postgresql/*/main/pg_hba.conf` and change auth method to `md5`
- **Node.js version conflicts**: Use `nvm` to manage Node.js versions

#### Windows Issues

- **PowerShell execution policy**: Run `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`
- **Path issues**: Ensure Node.js and PostgreSQL are in your system PATH

### Getting Help

If you encounter issues not covered here:

1. Check the [Troubleshooting Guide](./troubleshooting.md)
2. Review the [Development Guide](./development.md)
3. Open an issue on GitHub with:
   - Your operating system and versions
   - Complete error messages
   - Steps to reproduce the issue
   - [Create Issue](https://github.com/raxITai/mcp-oauth-sample/issues/new)

## Next Steps

Once your setup is complete:

1. **Read the [Architecture Guide](./architecture.md)** to understand the system design
2. **Review [Security Features](./security.md)** to understand the security implementation
3. **Explore [Analytics Features](./analytics.md)** to learn about the dashboard
4. **Check [Deployment Guide](./deployment.md)** when ready to deploy to production

## Production Considerations

Before deploying to production:

1. **Environment Variables**: Update all URLs to production domains
2. **Database**: Use a managed PostgreSQL service (AWS RDS, Google Cloud SQL, etc.)
3. **Security**: Generate new AUTH_SECRET and rotate all credentials
4. **Monitoring**: Set up logging and monitoring for the application
5. **Backup**: Configure regular database backups
6. **SSL**: Ensure HTTPS is enabled for all endpoints

---

**Need help?** Check our [troubleshooting guide](./troubleshooting.md) or open an issue on GitHub.